<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/vaadin-context-menu/vaadin-context-menu.html">

<dom-module id="analyzer-context-menu">
    <script>
        /**
         * A context-menu element based on the `vaadin-context-menu`.
         *
         * Expands parent functionality adding an ability to adjust position
         * relative to the viewport borders (i.e. when open near the viewport borders).
         *
         * This element is intended to handle the stacking contexts problem
         * (@see https://github.com/PolymerElements/paper-menu-button/issues/9#issuecomment-199478430 ,
         *  https://github.com/PolymerElements/iron-overlay-behavior/pull/155).
         * If no stacking contexts expected, use `analyzer-dropdown-menu` instead.
         */
        class AnalyzerContextMenu extends Vaadin.ContextMenuElement {
            static get is() {
                return 'analyzer-context-menu';
            }

            static get properties() {
                return {
                    /**
                     * An indent in pixels between the target element and the popup.
                     * Default value: 8px;
                     */
                    indent: {
                        type: Number,
                        value: 8
                    }
                }
            }

            constructor() {
                super();
                this._resizeHandler = this._handleResize.bind(this);
                this._keydownHandler = this._handleKeyDown.bind(this);
                window.addEventListener("resize", this._resizeHandler);
                window.addEventListener("keydown", this._keydownHandler, true);
            }

            disconnectedCallback() {
                super.disconnectedCallback();
                window.removeEventListener("resize", this._resizeHandler);
                window.removeEventListener("keydown", this._keydownHandler);
            }

            open(event) {
                if (!this.opened) {
                    super.open(event);
                    this._alignPopup(event);
                } else {
                    this.close();
                }
            }

            _alignPopup(event) {
                const targetCords = event.target.getBoundingClientRect();
                const menuElement = document.querySelector("vaadin-context-menu-overlay");
                const container = menuElement.parentNode;
                const indent = this.indent;

                if (menuElement) {
                    const content = menuElement.$.content;
                    const width = this._elementMaxWidth(content);
                    const height = this._elementMaxHeight(content);

                    if (targetCords.left + width + indent < container.clientWidth) {
                        menuElement.style.left = targetCords.left + "px";
                    } else if (targetCords.right - width - indent > 0) {
                        menuElement.style.left = targetCords.right - content.scrollWidth + "px";
                    } else {
                        menuElement.style.left = indent + "px";
                    }

                    if (targetCords.bottom + height + indent * 2 < container.clientHeight) {
                        menuElement.style.top = targetCords.bottom + indent + "px";
                    } else if (targetCords.top - height - indent * 2 > 0) {
                        menuElement.style.top = targetCords.top - content.scrollHeight - indent + "px";
                    } else {
                        menuElement.style.top = indent + "px";
                    }
                }
            }

            _elementMaxWidth(elem) {
                return this._getElementMaxSize(elem, "Width");
            }

            _elementMaxHeight(elem) {
                return this._getElementMaxSize(elem, "Height");
            }

            _getElementMaxSize(elem, sizeParam) {
                return Math.max(elem['scroll' + sizeParam], elem['client' + sizeParam]);
            }

            _handleResize() {
                if (this.opened) {
                    this.close();
                }
            }

            _handleKeyDown(event) {
                if (this._isTabKey(event) || this._isEscKey(event)) {
                    this.close();
                }
            }

            _isTabKey(event) {
                return event.key.toLowerCase() === "tab" ||
                    (event.detail && event.detail.key.toLowerCase() === "tab") ||
                    event.keyCode === 9;
            }

            _isEscKey(event) {
                return event.key === "Escape" ||
                    (event.detail && event.detail.key === "Escape") ||
                    event.keyCode === 27;
            }
        }

        window.customElements.define(AnalyzerContextMenu.is, AnalyzerContextMenu);
    </script>
</dom-module>

